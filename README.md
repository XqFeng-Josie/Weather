# Weather Prediction System

## ğŸ—ï¸ æ¨¡å‹æ¶æ„

### 1. Linear Regression (lr)
- **åŸç†**ï¼šRidgeå›å½’ï¼Œå¯¹æ¯ä¸ªæ—¶é—´æ­¥è¿›è¡Œç‹¬ç«‹é¢„æµ‹
- **é€‚ç”¨**ï¼šå•å˜é‡å¿«é€Ÿbaseline
- **å±€é™**ï¼šæ— æ—¶åºå»ºæ¨¡ï¼Œå¤šå˜é‡æ—¶é€€åŒ–

### 2. Multi-Output LR (lr_multi)
- **åŸç†**ï¼šæ¯ä¸ª**å˜é‡**ä¸€ä¸ªç‹¬ç«‹Ridgeæ¨¡å‹ï¼ˆå¦‚2m_temperatureä¸€ä¸ªï¼Œgeopotentialä¸€ä¸ªï¼‰
- **ç‰¹ç‚¹**ï¼šé¿å…å˜é‡é—´å¹²æ‰°ï¼ŒRidgeæ­£åˆ™åŒ–é˜²æ­¢ç—…æ€çŸ©é˜µ
- **æ€§èƒ½**ï¼šå¿«é€Ÿï¼ˆå¹¶è¡Œè®­ç»ƒï¼‰ï¼Œå¤šå˜é‡åŸºçº¿
- **å®ç°**ï¼š`n_variables`ä¸ªRidgeæ¨¡å‹ï¼Œæ¯ä¸ªé¢„æµ‹è¯¥å˜é‡çš„æ‰€æœ‰ç½‘æ ¼ç‚¹

### 3. LSTM
- **åŸç†**ï¼šå¾ªç¯ç¥ç»ç½‘ç»œï¼Œå»ºæ¨¡æ—¶é—´ä¾èµ–
- **ç»“æ„**ï¼šè¾“å…¥å±•å¹³ â†’ LSTM â†’ å…¨è¿æ¥ â†’ è¾“å‡º
- **é€‚ç”¨**ï¼šå•å˜é‡æ—¶é—´åºåˆ—
- **å±€é™**ï¼šå±•å¹³ä¸¢å¤±ç©ºé—´ä¿¡æ¯

### 4. Transformer
- **åŸç†**ï¼šè‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼Œæ•è·é•¿è·ç¦»ä¾èµ–
- **ç»“æ„**ï¼šä½ç½®ç¼–ç  â†’ Transformerç¼–ç å™¨ â†’ å…¨è¿æ¥
- **é—®é¢˜**ï¼šæ˜“è¿‡æ‹Ÿåˆï¼Œå•å˜é‡æ—¶éœ€å°æ¨¡å‹ï¼ˆd_model=64, layers=2ï¼‰
- **å»ºè®®**ï¼šä¸æ¨èä½¿ç”¨ï¼ˆå³ä½¿ä¼˜åŒ–åä»å®¹æ˜“é€€åŒ–ï¼‰

### 5. CNN
- **åŸç†**ï¼šå·ç§¯ç¥ç»ç½‘ç»œï¼Œæå–ç©ºé—´ç‰¹å¾
- **ç»“æ„**ï¼šConv2D â†’ BatchNorm â†’ ReLU â†’ Flatten â†’ FC
- **é€‚ç”¨**ï¼šç©ºé—´é¢„æµ‹ï¼Œå¤šå˜é‡
- **å±€é™**ï¼šæ— æ—¶åºå»ºæ¨¡

### 6. ConvLSTM
- **åŸç†**ï¼šç»“åˆCNNå’ŒLSTMï¼ŒåŒæ—¶å»ºæ¨¡æ—¶ç©ºä¾èµ–
- **ç»“æ„**ï¼šConvLSTMå•å…ƒï¼ˆå·ç§¯+LSTMé—¨æ§ï¼‰â†’ Conv2Dè¾“å‡º
- **ä¼˜åŠ¿**ï¼šä¿ç•™ç©ºé—´ç»“æ„ï¼Œå»ºæ¨¡æ—¶åºï¼Œé€‚åˆå¤šå˜é‡
- **æ¨è**ï¼šæœ€é€‚åˆå¤©æ°”é¢„æµ‹

### 7. Diffusion (diffusion) - æ¦‚ç‡é¢„æµ‹ â­

**æ ¸å¿ƒæ€æƒ³**ï¼šä¸é¢„æµ‹å•ä¸€ç¡®å®šå€¼ï¼Œè€Œæ˜¯é¢„æµ‹æ¦‚ç‡åˆ†å¸ƒ

#### åŸç†
- **å‰å‘è¿‡ç¨‹**ï¼šé€æ­¥å‘æ•°æ®æ·»åŠ å™ªå£°ï¼ˆè®­ç»ƒæ—¶æ¨¡æ‹Ÿï¼‰
- **åå‘è¿‡ç¨‹**ï¼šä»å™ªå£°é€æ­¥å»å™ªæ¢å¤æ•°æ®ï¼ˆæ¨ç†æ—¶ä½¿ç”¨ï¼‰
- **è®­ç»ƒç›®æ ‡**ï¼šå­¦ä¹ é¢„æµ‹æ¯ä¸€æ­¥æ·»åŠ çš„å™ªå£°
- **æ¨ç†è¿‡ç¨‹**ï¼šä»éšæœºå™ªå£°å¼€å§‹ï¼Œè¿­ä»£å»å™ªç”Ÿæˆé¢„æµ‹

#### æ¶æ„
```
è¾“å…¥å†å²: (12, 1, 64, 32) â†’ Condition Encoder
                                    â†“
éšæœºå™ªå£°: (4, 1, 64, 32) â”€â”€â†’ UNet Denoiser â”€â”€â†’ é¢„æµ‹è¾“å‡º
                            (å¤šæ¬¡è¿­ä»£å»å™ª)
```

**UNet Denoiser**ï¼š
- Down: Conv2D + GroupNorm + SiLU (æå–ç‰¹å¾)
- Middle: ResNet blocks (å¤„ç†ç‰¹å¾)
- Up: ConvTranspose2D + Skip connections (é‡å»ºç©ºé—´)
- Time Embedding: æ³¨å…¥å™ªå£°çº§åˆ«ä¿¡æ¯

#### Ensemble Forecasting

**ä¸ºä»€ä¹ˆéœ€è¦ Ensembleï¼Ÿ**
- Diffusion çš„éšæœºæ€§ï¼šæ¯æ¬¡æ¨ç†ä»ä¸åŒéšæœºå™ªå£°å¼€å§‹
- è‡ªç„¶äº§ç”Ÿå¤šæ ·æ€§ï¼šæ— éœ€é¢å¤–è®¾è®¡
- æ¦‚ç‡é¢„æµ‹ï¼šç”Ÿæˆå¤šä¸ªå¯èƒ½çš„æœªæ¥åœºæ™¯

**è¯„ä¼°æŒ‡æ ‡**ï¼š
- **CRPS** (Continuous Ranked Probability Score)ï¼šè¯„ä¼°æ¦‚ç‡åˆ†å¸ƒè´¨é‡
- **Spread-Skill Ratio**ï¼šæ£€éªŒ ensemble æ ¡å‡†ï¼ˆç†æƒ³å€¼ â‰ˆ 1.0ï¼‰
- **Ensemble Mean RMSE**ï¼šä¸ç¡®å®šæ€§æ¨¡å‹å¯¹æ¯”



## ğŸ“Š æ•°æ®è¯´æ˜

### æ•°æ®æº
- **WeatherBench2**ï¼šå…¨çƒERA5å†åˆ†ææ•°æ®
- **åˆ†è¾¨ç‡**ï¼š64Ã—32ç­‰è§’ç½‘æ ¼ï¼ˆç»åº¦Ã—çº¬åº¦ï¼‰
- **æ—¶é—´é—´éš”**ï¼š6å°æ—¶
- **æ—¶é—´èŒƒå›´**ï¼š1959-01-01 åˆ° 2021-12-31ï¼ˆæ³¨æ„ï¼šå°½ç®¡è·¯å¾„åä¸º"1959-2022"ï¼Œä½†å®é™…åªåˆ°2021å¹´åº•ï¼‰

### æ•°æ®ç»“æ„

```python
# åŸå§‹æ•°æ® (xarray Dataset)
ds = {
    '2m_temperature': (time, lat, lon),           # (N, 32, 64)
    'geopotential': (time, level, lat, lon),      # (N, 3, 32, 64) - é€‰æ‹©500/700/850hPa
    ...
}

# Flatæ ¼å¼ï¼ˆlr, lstm, transformerï¼‰
X: (n_samples, input_length, n_features)
   n_features = n_variables Ã— 32 Ã— 64
   ä¾‹ï¼šå•å˜é‡ n_features=2048ï¼ŒåŒå˜é‡ n_features=4096

# Spatialæ ¼å¼ï¼ˆcnn, convlstmï¼‰
X: (n_samples, input_length, n_channels, H, W)
   n_channels = n_variables (+ levels)
   H=32, W=64
```
**Note**ï¼šæ¯ä¸ªå˜é‡ç‹¬ç«‹æ ‡å‡†åŒ–ï¼ˆå‡å€¼0ï¼Œæ–¹å·®1ï¼‰

### åºåˆ—åˆ’åˆ†

- **è¾“å…¥é•¿åº¦** (`input_length=12`)ï¼šè¿‡å»12ä¸ªæ—¶é—´æ­¥ï¼ˆ3å¤©ï¼‰
- **è¾“å‡ºé•¿åº¦** (`output_length=4`)ï¼šæœªæ¥4ä¸ªæ—¶é—´æ­¥ï¼ˆ1å¤©ï¼‰
- **æ»‘åŠ¨çª—å£**ï¼šæ¯æ¬¡ç§»åŠ¨1æ­¥


### æŸå¤±å‡½æ•°

- **åˆå§‹æƒé‡**ï¼šå‡ç­‰åˆ†é…
- **åŠ¨æ€è°ƒæ•´**ï¼šæ ¹æ®å„å˜é‡lossçš„EMAè‡ªåŠ¨è°ƒæ•´æƒé‡
- **warmupæœŸ**ï¼šå‰100æ­¥ä¸è°ƒæ•´ï¼Œè®©æ¨¡å‹ç¨³å®š
- **æ›´æ–°é¢‘ç‡**ï¼šæ¯50æ­¥è°ƒæ•´ä¸€æ¬¡æƒé‡


## ğŸ”¬ è¯„ä¼°æŒ‡æ ‡

- æ•´ä½“æŒ‡æ ‡ï¼šæ‰€æœ‰å˜é‡æ··åˆè®¡ç®—
- å˜é‡çº§æŒ‡æ ‡ï¼š`var_0_rmse`, `var_0_mae`, `var_1_rmse`, `var_1_mae`
- å­˜å‚¨åœ¨`metrics.json`ä¸­


### 1. åŸºç¡€æŒ‡æ ‡
- **RMSE**ï¼šå‡æ–¹æ ¹è¯¯å·®ï¼ˆä¸»è¦æŒ‡æ ‡ï¼‰
- **MAE**ï¼šå¹³å‡ç»å¯¹è¯¯å·®
- **RÂ²**ï¼šå†³å®šç³»æ•°

### 2. æ—¶é—´åˆ†è¾¨
- **RMSE per Lead Time**ï¼šæ¯ä¸ªé¢„æµ‹æ­¥é•¿çš„RMSE
- ç”¨äºåˆ†æè¯¯å·®éšé¢„æµ‹æ—¶é•¿çš„å¢é•¿

### 3. ç©ºé—´åˆ†è¾¨
- **ç©ºé—´è¯¯å·®å›¾**ï¼šå¯è§†åŒ–ä¸åŒåŒºåŸŸçš„é¢„æµ‹è¯¯å·®
- è¯†åˆ«æ¨¡å‹åœ¨ç‰¹å®šåŒºåŸŸçš„ä¼˜åŠ£

### 4. WeatherBench2æ ‡å‡†
- **Bias**ï¼šç³»ç»Ÿåå·®
- **ACC**ï¼šè·å¹³ç›¸å…³ç³»æ•°
- **Skill Score**ï¼šç›¸å¯¹äºåŸºçº¿çš„æ”¹è¿›


## ğŸ“ é¡¹ç›®ç»“æ„

```
Weather/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ data_loader.py          # æ•°æ®åŠ è½½å’Œé¢„å¤„ç†
â”‚   â”œâ”€â”€ trainer.py              # è®­ç»ƒå™¨ï¼ˆæ”¯æŒsklearnå’ŒPyTorchï¼‰
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py         # æ¨¡å‹å·¥å‚
â”‚   â”‚   â”œâ”€â”€ linear_regression.py    # LRå’ŒMultiOutputLR
â”‚   â”‚   â”œâ”€â”€ lstm.py             # LSTM
â”‚   â”‚   â”œâ”€â”€ transformer.py      # Transformer
â”‚   â”‚   â”œâ”€â”€ cnn.py              # CNN
â”‚   â”‚   â”œâ”€â”€ convlstm.py         # ConvLSTM
â”‚   â”‚   â””â”€â”€ diffusion/          # Diffusionæ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ diffusion_model.py      # ä¸»æ¨¡å‹
â”‚   â”‚       â”œâ”€â”€ diffusion_trainer.py    # è®­ç»ƒå™¨ï¼ˆå«ensembleï¼‰
â”‚   â”‚       â”œâ”€â”€ unet_simple.py          # UNetæ¶æ„
â”‚   â”‚       â””â”€â”€ noise_scheduler.py      # å™ªå£°è°ƒåº¦
â”‚   â””â”€â”€ metrics/
â”‚       â””â”€â”€ probabilistic.py    # æ¦‚ç‡è¯„ä¼°æŒ‡æ ‡ï¼ˆCRPSç­‰ï¼‰
â”œâ”€â”€ scripts/                    # è¿è¡Œè„šæœ¬ â­
â”‚   â”œâ”€â”€ run_lr_multi.sh         # LR Multi (è®­ç»ƒ+é¢„æµ‹+è¯„ä¼°)
â”‚   â”œâ”€â”€ run_lstm.sh             # LSTM (è®­ç»ƒ+é¢„æµ‹+è¯„ä¼°)
â”‚   â”œâ”€â”€ run_cnn.sh              # CNN (è®­ç»ƒ+é¢„æµ‹+è¯„ä¼°)
â”‚   â”œâ”€â”€ run_convlstm.sh         # ConvLSTM (è®­ç»ƒ+é¢„æµ‹+è¯„ä¼°)
â”‚   â”œâ”€â”€ run_diffusion.sh        # Diffusion åŸºç¡€ (è®­ç»ƒ+é¢„æµ‹+è¯„ä¼°)
â”‚   â””â”€â”€ run_diffusion_ensemble.sh   # Diffusion Ensemble (è®­ç»ƒ+é¢„æµ‹+è¯„ä¼°)
â”œâ”€â”€ train.py                    # è®­ç»ƒè„šæœ¬ï¼ˆç¡®å®šæ€§æ¨¡å‹ï¼‰
â”œâ”€â”€ train_diffusion.py          # Diffusionè®­ç»ƒè„šæœ¬
â”œâ”€â”€ predict.py                  # é¢„æµ‹è„šæœ¬
â”œâ”€â”€ evaluate_diffusion_ensemble.py  # Ensembleè¯„ä¼°å·¥å…·
â”œâ”€â”€ evaluate_weatherbench.py    # WeatherBench2è¯„ä¼°
â”œâ”€â”€ USAGE.md                    # ä½¿ç”¨æŒ‡å— â­
â””â”€â”€ README.md                   # æœ¬æ–‡ä»¶ â­

outputs/                        # è®­ç»ƒè¾“å‡º
â””â”€â”€ <exp_name>/
    â”œâ”€â”€ best_model.pth
    â”œâ”€â”€ config.json
    â”œâ”€â”€ metrics.json            # åŒ…å«ç¡®å®šæ€§å’Œæ¦‚ç‡æŒ‡æ ‡
    â”œâ”€â”€ predictions_*.png       # é¢„æµ‹å›¾
    â”œâ”€â”€ ensemble_*.png          # Ensembleå¯è§†åŒ–ï¼ˆå¦‚å¯ç”¨ï¼‰
    â””â”€â”€ ensemble_predictions.npy    # Ensembleæ•°æ®ï¼ˆå¦‚å¯ç”¨ï¼‰
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

è¯¦ç»†ä½¿ç”¨è¯´æ˜è§ [USAGE.md](USAGE.md)

## ğŸ“š å‚è€ƒèµ„æ–™

### æ•°æ®å’ŒåŸºå‡†
- [WeatherBench2](https://weatherbench2.readthedocs.io/) - å¤©æ°”é¢„æµ‹åŸºå‡†
-> WeatherBench: train (1979-2016), test(2017-2018), WeatherBench2: train (1979-2019), test(2020)
- [ERA5](https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5) - ECMWFå†åˆ†ææ•°æ®

### æ¨¡å‹è®ºæ–‡
- [ConvLSTM](https://arxiv.org/abs/1506.04214) - Shi et al., 2015
- [DDPM](https://arxiv.org/abs/2006.11239) - Ho et al., 2020 (Diffusion æ¨¡å‹åŸºç¡€)
- [GenCast](https://arxiv.org/abs/2312.15796) - Price et al., 2023 (æ¦‚ç‡å¤©æ°”é¢„æµ‹)