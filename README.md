# Weather Prediction System

åŸºäºæ·±åº¦å­¦ä¹ çš„æ°”è±¡é¢„æµ‹ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§æ¨¡å‹æ¶æ„å’Œé¢„æµ‹æ–¹å¼ã€‚

## ğŸ¯ é¡¹ç›®ç›®æ ‡

æœ¬é¡¹ç›®æ—¨åœ¨ä½¿ç”¨æ·±åº¦å­¦ä¹ æŠ€æœ¯è¿›è¡Œå…¨çƒå¤©æ°”é¢„æµ‹ï¼Œä¸»è¦è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š

- **çŸ­æœŸå¤©æ°”é¢„æµ‹**ï¼šé¢„æµ‹æœªæ¥1å¤©ï¼ˆ4ä¸ªæ—¶é—´æ­¥ï¼Œ6å°æ—¶é—´éš”ï¼‰çš„å¤©æ°”çŠ¶å†µ
- **å¤šå˜é‡é¢„æµ‹**ï¼šæ”¯æŒæ¸©åº¦ã€ä½åŠ¿é«˜åº¦ã€é£é€Ÿç­‰å¤šä¸ªæ°”è±¡å˜é‡
- **ä¸ç¡®å®šæ€§é‡åŒ–**ï¼šé€šè¿‡æ¦‚ç‡é¢„æµ‹æ–¹æ³•é‡åŒ–é¢„æµ‹çš„ä¸ç¡®å®šæ€§
- **å…¨çƒè¦†ç›–**ï¼šåŸºäºERA5å…¨çƒå†åˆ†ææ•°æ®ï¼Œåˆ†è¾¨ç‡64Ã—32ç½‘æ ¼

## ğŸ“Š æ•°æ®è¯´æ˜

### æ•°æ®æº

- **æ¥æº**: WeatherBench2 - ERA5å†åˆ†ææ•°æ®
- **è·¯å¾„**: `gs://weatherbench2/datasets/era5/1959-2022-6h-64x32_equiangular_conservative.zarr`
- **åˆ†è¾¨ç‡**: 64Ã—32ç­‰è§’ç½‘æ ¼ï¼ˆç»åº¦Ã—çº¬åº¦ï¼‰
- **ç»åº¦èŒƒå›´**:[0.00, 354.38]
- **ç»´åº¦èŒƒå›´**:[-87.19, 87.19]
- **æ—¶é—´é—´éš”**: 6å°æ—¶
- **æ—¶é—´ç‚¹**: 92044
- **æ—¶é—´èŒƒå›´**: 1959-01-01 åˆ° 2021-12-31

### ä¸»è¦å˜é‡

| å˜é‡å | è¯´æ˜ | ç»´åº¦ |
|--------|------|------|
| `2m_temperature` | 2ç±³æ¸©åº¦ | (time, lat, lon) |
| `geopotential` | ä½åŠ¿é«˜åº¦ | (time, level, lat, lon) |
| `10m_u_component_of_wind` | 10ç±³Ué£ | (time, lat, lon) |
| `10m_v_component_of_wind` | 10ç±³Vé£ | (time, lat, lon) |
| `specific_humidity` | æ¯”æ¹¿ | (time, level, lat, lon) |

### æ•°æ®æ ¼å¼

```python
# è¾“å…¥åºåˆ—
X: (n_samples, input_length, features)
   input_length = 12  # è¿‡å»12ä¸ªæ—¶é—´æ­¥ï¼ˆ3å¤©ï¼‰

# è¾“å‡ºåºåˆ—  
Y: (n_samples, output_length, features)
   output_length = 4  # æœªæ¥4ä¸ªæ—¶é—´æ­¥ï¼ˆ1å¤©ï¼‰
```

## ğŸ—ï¸ æ¨¡å‹æ¶æ„

### 1. ä¼ ç»Ÿæ·±åº¦å­¦ä¹ æ¨¡å‹

#### Linear Regression (lr)
- **åŸç†**: Ridgeå›å½’ï¼Œå•å˜é‡å¿«é€ŸåŸºçº¿
- **ç‰¹ç‚¹**: æ— æ—¶åºå»ºæ¨¡ï¼Œè®­ç»ƒå¿«é€Ÿ
- **é€‚ç”¨**: å¿«é€ŸåŸºçº¿æµ‹è¯•

#### Multi-Output LR (lr_multi)
- **åŸç†**: æ¯ä¸ªå˜é‡ç‹¬ç«‹çš„Ridgeæ¨¡å‹
- **ç‰¹ç‚¹**: é¿å…å˜é‡é—´å¹²æ‰°ï¼Œæ”¯æŒå¹¶è¡Œè®­ç»ƒ
- **é€‚ç”¨**: å¤šå˜é‡åŸºçº¿

#### LSTM
- **åŸç†**: å¾ªç¯ç¥ç»ç½‘ç»œï¼Œå»ºæ¨¡æ—¶é—´ä¾èµ–
- **ç»“æ„**: è¾“å…¥å±•å¹³ â†’ LSTM â†’ å…¨è¿æ¥
- **å±€é™**: ä¸¢å¤±ç©ºé—´ä¿¡æ¯
- **é€‚ç”¨**: å•å˜é‡æ—¶é—´åºåˆ—

#### CNN
- **åŸç†**: å·ç§¯ç¥ç»ç½‘ç»œï¼Œæå–ç©ºé—´ç‰¹å¾
- **ç»“æ„**: Conv2D â†’ BatchNorm â†’ ReLU â†’ FC
- **å±€é™**: æ— æ—¶åºå»ºæ¨¡
- **é€‚ç”¨**: ç©ºé—´æ¨¡å¼é¢„æµ‹

#### ConvLSTM â­
- **åŸç†**: ç»“åˆCNNå’ŒLSTMï¼ŒåŒæ—¶å»ºæ¨¡æ—¶ç©ºä¾èµ–
- **ç»“æ„**: ConvLSTMå•å…ƒ â†’ Conv2Dè¾“å‡º
- **ä¼˜åŠ¿**: ä¿ç•™ç©ºé—´ç»“æ„ï¼Œå»ºæ¨¡æ—¶åº
- **æ¨è**: æœ€é€‚åˆå¤©æ°”é¢„æµ‹çš„ç¡®å®šæ€§æ¨¡å‹

#### Weather Transformer
- **åŸç†**: Factorizedæ—¶ç©ºæ³¨æ„åŠ›æœºåˆ¶
- **ç»“æ„**: Patch Embedding â†’ Spatial + Temporal Attention
- **ç‰¹ç‚¹**: è½»é‡çº§è®¾è®¡ï¼Œçº¦1.6Må‚æ•°
- **é€‚ç”¨**: æ•è·é•¿è·ç¦»æ—¶ç©ºä¾èµ–

### 2. WeatherDiff æ¨¡å— â­

åŸºäºStable Diffusionæ¶æ„çš„å¤©æ°”é¢„æµ‹æ¨¡å—ï¼Œå°†æ°”è±¡ç½‘æ ¼æ•°æ®è§†ä¸ºå›¾åƒï¼Œåˆ©ç”¨é¢„è®­ç»ƒVAEå’ŒU-Netæ¶æ„è¿›è¡Œæ—¶ç©ºé¢„æµ‹ã€‚

**æ¨¡å—ç»„æˆ**ï¼š
```
weatherdiff/
â”œâ”€â”€ vae/          # Stable Diffusion VAEåŠŸèƒ½
â”œâ”€â”€ unet/         # U-Netæ¨¡å‹ï¼ˆåƒç´ å’Œæ½œç©ºé—´ï¼‰
â”œâ”€â”€ diffusion/    # æ‰©æ•£æ¨¡å‹
â””â”€â”€ utils/        # å·¥å…·å‡½æ•°
```

#### Pixel U-Net
- **åŸç†**: å›¾åƒåˆ°å›¾åƒçš„ç¡®å®šæ€§é¢„æµ‹
- **ç»“æ„**: U-Netæ¶æ„ï¼Œç›´æ¥åœ¨åƒç´ ç©ºé—´é¢„æµ‹
- **è¾“å…¥**: è¿‡å»Nå¸§å›¾åƒ â†’ æœªæ¥Må¸§å›¾åƒ
- **ç‰¹ç‚¹**: è®­ç»ƒå¿«é€Ÿï¼Œç»“æœç¡®å®š

#### Latent U-Net â­
- **åŸç†**: åœ¨VAEæ½œç©ºé—´ä¸­é¢„æµ‹ï¼ˆSD-VAE)
- **ä¼˜åŠ¿**: 
  - æ˜¾å­˜éœ€æ±‚ä½ï¼ˆ512Ã—512 â†’ 64Ã—64æ½œç©ºé—´ï¼‰
  - è®­ç»ƒæ›´ç¨³å®š
  - ç”Ÿæˆç»“æœæ›´å¹³æ»‘
- **ä½¿ç”¨**: Stable Diffusioné¢„è®­ç»ƒVAE
- **æ¨è**: åœ¨å¤§å°ºå¯¸æ•°æ®ä¸Šè®­ç»ƒæ—¶ä½¿ç”¨

#### Diffusion Model â­
- **åŸç†**: æ‰©æ•£æ¨¡å‹ï¼Œæ¦‚ç‡é¢„æµ‹ (SD-VAD+U-Net+diffusion)
- **è®­ç»ƒ**: å­¦ä¹ å¦‚ä½•â€œå»å™ªâ€æœªæ¥æ½œå‘é‡ï¼Œä»å™ªå£°æ¢å¤å‡ºçœŸå®æœªæ¥ã€‚
- **æ¨ç†**: ä»å™ªå£°é€æ­¥å»å™ªç”Ÿæˆé¢„æµ‹
- **ç‰¹ç‚¹**:
  - æ”¯æŒç”Ÿæˆå¤šä¸ªæœªæ¥åœºæ™¯
  - é‡åŒ–é¢„æµ‹ä¸ç¡®å®šæ€§
  - é€‚åˆé›†æˆé¢„æµ‹
- **æ¨è**: éœ€è¦ä¸ç¡®å®šæ€§ä¼°è®¡æ—¶ä½¿ç”¨

### 3. æ¨¡å‹å¯¹æ¯”

| æ¨¡å‹ | æ—¶ç©ºå»ºæ¨¡ | è®­ç»ƒé€Ÿåº¦ | æ¨ç†é€Ÿåº¦ | ä¸ç¡®å®šæ€§ | æ¨èåœºæ™¯ |
|------|---------|---------|---------|---------|---------|
| Linear Regression | âœ— | âš¡âš¡âš¡ | âš¡âš¡âš¡ | âœ— | å¿«é€ŸåŸºçº¿ |
| LSTM | æ—¶åº | âš¡âš¡ | âš¡âš¡ | âœ— | å•å˜é‡æ—¶åº |
| CNN | ç©ºé—´ | âš¡âš¡ | âš¡âš¡âš¡ | âœ— | ç©ºé—´æ¨¡å¼ |
| ConvLSTM | æ—¶ç©º | âš¡ | âš¡âš¡ | âœ— | é€šç”¨é¢„æµ‹ â­ |
| Transformer | æ—¶ç©º | âš¡ | âš¡ | âœ— | é•¿è·ç¦»ä¾èµ– |
| Pixel U-Net | æ—¶ç©º | âš¡âš¡ | âš¡âš¡ | âœ— | å›¾åƒé¢„æµ‹ |
| Latent U-Net | æ—¶ç©º | âš¡âš¡ | âš¡âš¡ | âœ— | å¤§å°ºå¯¸å›¾åƒ â­ |
| Diffusion | æ—¶ç©º | ğŸ¢ | ğŸ¢ | âœ“ | æ¦‚ç‡é¢„æµ‹ â­ |

## ğŸ“ˆ è¯„ä¼°æŒ‡æ ‡

### VAEé‡å»ºæŒ‡æ ‡

- **ç›¸å…³ç³»æ•°**: ç©ºé—´æ¨¡å¼ç›¸ä¼¼åº¦
- **SSIM**: ç»“æ„ç›¸ä¼¼æ€§æŒ‡æ•°ï¼ˆå›¾åƒè´¨é‡ï¼‰
- **PSNR**: å³°å€¼ä¿¡å™ªæ¯”ï¼ˆå›¾åƒè´¨é‡ï¼‰

### ç¡®å®šæ€§æŒ‡æ ‡
- **RMSE** (Root Mean Square Error): å‡æ–¹æ ¹è¯¯å·®ï¼Œä¸»è¦æŒ‡æ ‡
- **MAE** (Mean Absolute Error): å¹³å‡ç»å¯¹è¯¯å·®

### æ¦‚ç‡æŒ‡æ ‡ï¼ˆDiffusionæ¨¡å‹ï¼‰

- **CRPS** (Continuous Ranked Probability Score): æ¦‚ç‡åˆ†å¸ƒè´¨é‡
- **Spread-Skill Ratio**: é›†æˆæ ¡å‡†ï¼ˆç†æƒ³å€¼ â‰ˆ 1.0ï¼‰
  - < 1.0: è¿‡åº¦è‡ªä¿¡
  - > 1.0: ä¸å¤Ÿè‡ªä¿¡
- **Ensemble Mean RMSE**: é›†æˆå¹³å‡è¯¯å·®

### æ—¶ç©ºåˆ†è¾¨æŒ‡æ ‡

- **RMSE vs Lead Time**: è¯¯å·®éšé¢„æµ‹æ­¥é•¿å˜åŒ–
- **ç©ºé—´è¯¯å·®å›¾**: ä¸åŒåŒºåŸŸçš„é¢„æµ‹ç²¾åº¦
- **æ—¶é—´åºåˆ—å›¾**: é¢„æµ‹å€¼ä¸çœŸå€¼çš„æ—¶é—´åºåˆ—å¯¹æ¯”

## ğŸ“ é¡¹ç›®ç»“æ„

```
Weather/
â”œâ”€â”€ src/                       # ä¼ ç»Ÿæ·±åº¦å­¦ä¹ æ¨¡å‹
â”‚   â”œâ”€â”€ data_loader.py         # æ•°æ®åŠ è½½
â”‚   â”œâ”€â”€ trainer.py             # è®­ç»ƒå™¨
â”‚   â”œâ”€â”€ visualization.py       # å¯è§†åŒ–
â”‚   â””â”€â”€ models/                # æ¨¡å‹å®ç°
â”‚       â”œâ”€â”€ linear_regression.py
â”‚       â”œâ”€â”€ lstm.py
â”‚       â”œâ”€â”€ cnn.py
â”‚       â”œâ”€â”€ convlstm.py
â”‚       â”œâ”€â”€ transformer.py
â”‚       â””â”€â”€ weather_transformer.py
â”‚
â”œâ”€â”€ weatherdiff/               # WeatherDiffæ¨¡å— â­
â”‚   â”œâ”€â”€ vae/                   # VAEåŠŸèƒ½ï¼ˆSDé¢„è®­ç»ƒï¼‰
â”‚   â”œâ”€â”€ unet/                  # U-Netæ¨¡å‹ï¼ˆåƒç´ /æ½œç©ºé—´ï¼‰
â”‚   â”œâ”€â”€ diffusion/             # æ‰©æ•£æ¨¡å‹
â”‚   â””â”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ scripts/                   # è¿è¡Œè„šæœ¬ â­
â”‚   â”œâ”€â”€ run_convlstm.sh
â”‚   â”œâ”€â”€ run_weather_transformer.sh
â”‚   â”œâ”€â”€ run_pixel_unet.sh
â”‚   â”œâ”€â”€ run_latent_unet_full.sh
â”‚   â””â”€â”€ run_diffusion.sh
â”‚
â”œâ”€â”€ train.py                   # ä¼ ç»Ÿæ¨¡å‹è®­ç»ƒ
â”œâ”€â”€ train_weather_transformer.py
â”œâ”€â”€ train_pixel_unet.py        # WeatherDiffè®­ç»ƒè„šæœ¬
â”œâ”€â”€ train_latent_unet.py
â”œâ”€â”€ train_diffusion.py
â”‚
â”œâ”€â”€ predict.py                 # ä¼ ç»Ÿæ¨¡å‹é¢„æµ‹
â”œâ”€â”€ predict_unet.py            # WeatherDiffé¢„æµ‹è„šæœ¬
â”œâ”€â”€ predict_diffusion.py
â”‚
â”œâ”€â”€ preprocess_data_for_latent_unet.py  # æ•°æ®é¢„å¤„ç†
â”œâ”€â”€ test_vae_reconstruction.py          # VAEé‡å»ºæµ‹è¯•
â”œâ”€â”€ compare_models.py                   # æ¨¡å‹å¯¹æ¯”
â”‚
â”œâ”€â”€ requirements.txt           # åŸºç¡€ä¾èµ–
â”œâ”€â”€ requirements_weatherdiff.txt  # WeatherDiffä¾èµ–
â”œâ”€â”€ README.md                  # æœ¬æ–‡ä»¶ â­
â””â”€â”€ USAGE.md                   # ä½¿ç”¨æŒ‡å— â­
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
# åŸºç¡€ä¾èµ–ï¼ˆä¼ ç»Ÿæ¨¡å‹ï¼‰
pip install -r requirements.txt

# WeatherDiffé¢å¤–ä¾èµ–ï¼ˆå¦‚æœä½¿ç”¨WeatherDiffæ¨¡å—ï¼‰
pip install -r requirements_weatherdiff.txt
```

### 2. å¿«é€Ÿè®­ç»ƒç¤ºä¾‹

```è§ scripts å†…è„šæœ¬
```

### 3. æŸ¥çœ‹ç»“æœ

è®­ç»ƒå®Œæˆåï¼Œç»“æœä¿å­˜åœ¨ `outputs/<model_name>/` ç›®å½•ï¼š

```
outputs/<model_name>/
â”œâ”€â”€ best_model.pt              # æœ€ä½³æ¨¡å‹æƒé‡
â”œâ”€â”€ config.json                # é…ç½®æ–‡ä»¶
â”œâ”€â”€ prediction_metrics.json    # è¯„ä¼°æŒ‡æ ‡
â”œâ”€â”€ predictions_data/          # é¢„æµ‹æ•°æ®
â”œâ”€â”€ timeseries_*.png          # æ—¶é—´åºåˆ—å›¾
â”œâ”€â”€ spatial_comparison_*.png   # ç©ºé—´å¯¹æ¯”å›¾
â””â”€â”€ rmse_vs_leadtime_*.png    # RMSE vsé¢„æµ‹æ­¥é•¿
```

## ğŸ”¬ å®éªŒç»“æœ

### ä¼ ç»Ÿæ·±åº¦å­¦ä¹ æ¨¡å‹

| æ¨¡å‹ | RMSE | MAE | RMSE (Step 1) | RMSE (Step 2) | RMSE (Step 3) | RMSE (Step 4) |
|------|------|-----|---------------|---------------|---------------|---------------|
| CNN | 0.0579 | 0.0363 | 0.0370 | 0.0511 | 0.0630 | 0.0739 |
| ConvLSTM | 0.0598 | 0.0365 | 0.0354 | 0.0526 | 0.0657 | 0.0772 |
| Weather Transformer | 0.0650 | 0.0416 | 0.0459 | 0.0590 | 0.0701 | 0.0800 |
| LSTM | 0.1233 | 0.0833 | 0.1215 | 0.1225 | 0.1238 | 0.1254 |
| Multi-Output LR | 0.1286 | 0.0846 | 0.1072 | 0.1228 | 0.1349 | 0.1461 |
| Transformer | 0.1622 | 0.1108 | 0.1620 | 0.1624 | 0.1622 | 0.1621 |

### WeatherDiff æ¨¡å—

| æ¨¡å‹ | RMSE | MAE | RMSE (Step 1) | RMSE (Step 2) | RMSE (Step 3) | RMSE (Step 4) |
|------|------|-----|---------------|---------------|---------------|---------------|
| Pixel U-Net | 0.7832 | 1.2523 | 0.7753 | 1.1281 | 1.3816 | 1.5782 |
| Latent U-Net | 1.5253 | 2.0983 | 2.0187 | 2.0570 | 2.1061 | 2.2065 |
| Diffusion | 20.7093 | 22.8268 | 22.4664 | 24.0609 | 21.7690 | 22.9492 |

**è¯´æ˜**ï¼š
- Step 1-4 åˆ†åˆ«å¯¹åº”æœªæ¥6ã€12ã€18ã€24å°æ—¶çš„é¢„æµ‹
- ä¼ ç»Ÿæ¨¡å‹ä¸­ï¼ŒCNNå’ŒConvLSTMè¡¨ç°æœ€ä½³ï¼ŒRMSEçº¦0.06
- WeatherDiffæ¨¡å—ä¸­ï¼ŒPixel U-Netè¡¨ç°æœ€å¥½ï¼Œä½†æ•´ä½“è¯¯å·®é«˜äºä¼ ç»Ÿæ¨¡å‹
- Diffusionæ¨¡å‹è¯¯å·®è¾ƒå¤§ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒä¼˜æˆ–æ›´å¤šè®­ç»ƒæ•°æ®


## ğŸ“š å‚è€ƒæ–‡çŒ®

### æ•°æ®å’ŒåŸºå‡†
- [WeatherBench2](https://weatherbench2.readthedocs.io/) - å¤©æ°”é¢„æµ‹åŸºå‡†
- [ERA5](https://www.ecmwf.int/en/forecasts/datasets/reanalysis-datasets/era5) - ECMWFå†åˆ†ææ•°æ®

### æ¨¡å‹è®ºæ–‡
- [ConvLSTM](https://arxiv.org/abs/1506.04214) - Shi et al., 2015
- [Transformer](https://arxiv.org/abs/1706.03762) - Vaswani et al., 2017
- [U-Net](https://arxiv.org/abs/1505.04597) - Ronneberger et al., 2015
- [DDPM](https://arxiv.org/abs/2006.11239) - Ho et al., 2020
- [Stable Diffusion](https://arxiv.org/abs/2112.10752) - Rombach et al., 2022

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚é‡é—®é¢˜æˆ–æœ‰å»ºè®®ï¼Œæ¬¢è¿æIssueæˆ–PRã€‚

---

æ›´å¤šè¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ [USAGE.md](USAGE.md)
